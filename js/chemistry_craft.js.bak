// Initial elements available to the user
const initialElements = [
    // Nonmetals
    { symbol: 'H', name: 'Hydrogen', color: '#E6E6E6', type: 'nonmetal' },
    { symbol: 'C', name: 'Carbon', color: '#666666', type: 'nonmetal' },
    { symbol: 'N', name: 'Nitrogen', color: '#99CCFF', type: 'nonmetal' },
    { symbol: 'O', name: 'Oxygen', color: '#FF9999', type: 'nonmetal' },
    { symbol: 'P', name: 'Phosphorus', color: '#FF9966', type: 'nonmetal' },
    { symbol: 'S', name: 'Sulfur', color: '#FFFF00', type: 'nonmetal' },
    { symbol: 'Se', name: 'Selenium', color: '#FFA07A', type: 'nonmetal' },

    // Noble Gases
    { symbol: 'He', name: 'Helium', color: '#FFE5CC', type: 'noble-gas' },
    { symbol: 'Ne', name: 'Neon', color: '#FF99CC', type: 'noble-gas' },
    { symbol: 'Ar', name: 'Argon', color: '#FF99CC', type: 'noble-gas' },
    { symbol: 'Kr', name: 'Krypton', color: '#FF99CC', type: 'noble-gas' },
    { symbol: 'Xe', name: 'Xenon', color: '#FF99CC', type: 'noble-gas' },
    { symbol: 'Rn', name: 'Radon', color: '#FF99CC', type: 'noble-gas' },
    { symbol: 'Og', name: 'Oganesson', color: '#FF99CC', type: 'noble-gas' },

    // Halogens
    { symbol: 'F', name: 'Fluorine', color: '#CCFF99', type: 'halogen' },
    { symbol: 'Cl', name: 'Chlorine', color: '#CCFF99', type: 'halogen' },
    { symbol: 'Br', name: 'Bromine', color: '#CCFF99', type: 'halogen' },
    { symbol: 'I', name: 'Iodine', color: '#CCFF99', type: 'halogen' },
    { symbol: 'At', name: 'Astatine', color: '#CCFF99', type: 'halogen' },
    { symbol: 'Ts', name: 'Tennessine', color: '#CCFF99', type: 'halogen' },

    // Alkali Metals
    { symbol: 'Li', name: 'Lithium', color: '#FF9999', type: 'alkali' },
    { symbol: 'Na', name: 'Sodium', color: '#FFB266', type: 'alkali' },
    { symbol: 'K', name: 'Potassium', color: '#FFB266', type: 'alkali' },
    { symbol: 'Rb', name: 'Rubidium', color: '#FFB266', type: 'alkali' },
    { symbol: 'Cs', name: 'Caesium', color: '#FFB266', type: 'alkali' },
    { symbol: 'Fr', name: 'Francium', color: '#FFB266', type: 'alkali' },

    // Alkaline Earth Metals
    { symbol: 'Be', name: 'Beryllium', color: '#FFD700', type: 'alkaline-earth' },
    { symbol: 'Mg', name: 'Magnesium', color: '#FFD700', type: 'alkaline-earth' },
    { symbol: 'Ca', name: 'Calcium', color: '#FFD700', type: 'alkaline-earth' },
    { symbol: 'Sr', name: 'Strontium', color: '#FFD700', type: 'alkaline-earth' },
    { symbol: 'Ba', name: 'Barium', color: '#FFD700', type: 'alkaline-earth' },
    { symbol: 'Ra', name: 'Radium', color: '#FFD700', type: 'alkaline-earth' },

    // Transition Metals
    { symbol: 'Sc', name: 'Scandium', color: '#CC9999', type: 'transition' },
    { symbol: 'Ti', name: 'Titanium', color: '#CC9999', type: 'transition' },
    { symbol: 'V', name: 'Vanadium', color: '#CC9999', type: 'transition' },
    { symbol: 'Cr', name: 'Chromium', color: '#CC9999', type: 'transition' },
    { symbol: 'Mn', name: 'Manganese', color: '#CC9999', type: 'transition' },
    { symbol: 'Fe', name: 'Iron', color: '#CC9999', type: 'transition' },
    { symbol: 'Co', name: 'Cobalt', color: '#CC9999', type: 'transition' },
    { symbol: 'Ni', name: 'Nickel', color: '#CC9999', type: 'transition' },
    { symbol: 'Cu', name: 'Copper', color: '#FF9966', type: 'transition' },
    { symbol: 'Zn', name: 'Zinc', color: '#98FF98', type: 'transition' },
    { symbol: 'Y', name: 'Yttrium', color: '#CC9999', type: 'transition' },
    { symbol: 'Zr', name: 'Zirconium', color: '#CC9999', type: 'transition' },
    { symbol: 'Nb', name: 'Niobium', color: '#CC9999', type: 'transition' },
    { symbol: 'Mo', name: 'Molybdenum', color: '#CC9999', type: 'transition' },
    { symbol: 'Tc', name: 'Technetium', color: '#CC9999', type: 'transition' },
    { symbol: 'Ru', name: 'Ruthenium', color: '#CC9999', type: 'transition' },
    { symbol: 'Rh', name: 'Rhodium', color: '#CC9999', type: 'transition' },
    { symbol: 'Pd', name: 'Palladium', color: '#CC9999', type: 'transition' },
    { symbol: 'Ag', name: 'Silver', color: '#C0C0C0', type: 'transition' },
    { symbol: 'Cd', name: 'Cadmium', color: '#CC9999', type: 'transition' },
    { symbol: 'Hf', name: 'Hafnium', color: '#CC9999', type: 'transition' },
    { symbol: 'Ta', name: 'Tantalum', color: '#CC9999', type: 'transition' },
    { symbol: 'W', name: 'Tungsten', color: '#CC9999', type: 'transition' },
    { symbol: 'Re', name: 'Rhenium', color: '#CC9999', type: 'transition' },
    { symbol: 'Os', name: 'Osmium', color: '#CC9999', type: 'transition' },
    { symbol: 'Ir', name: 'Iridium', color: '#CC9999', type: 'transition' },
    { symbol: 'Pt', name: 'Platinum', color: '#E5E4E2', type: 'transition' },
    { symbol: 'Au', name: 'Gold', color: '#FFD700', type: 'transition' },
    { symbol: 'Hg', name: 'Mercury', color: '#B8B8B8', type: 'transition' },

    // Post-transition Metals
    { symbol: 'Al', name: 'Aluminum', color: '#BCC6CC', type: 'post-transition' },
    { symbol: 'Ga', name: 'Gallium', color: '#BCC6CC', type: 'post-transition' },
    { symbol: 'In', name: 'Indium', color: '#BCC6CC', type: 'post-transition' },
    { symbol: 'Sn', name: 'Tin', color: '#BCC6CC', type: 'post-transition' },
    { symbol: 'Tl', name: 'Thallium', color: '#BCC6CC', type: 'post-transition' },
    { symbol: 'Pb', name: 'Lead', color: '#BCC6CC', type: 'post-transition' },
    { symbol: 'Bi', name: 'Bismuth', color: '#BCC6CC', type: 'post-transition' },
    { symbol: 'Po', name: 'Polonium', color: '#BCC6CC', type: 'post-transition' },
    { symbol: 'Nh', name: 'Nihonium', color: '#BCC6CC', type: 'post-transition' },
    { symbol: 'Fl', name: 'Flerovium', color: '#BCC6CC', type: 'post-transition' },
    { symbol: 'Mc', name: 'Moscovium', color: '#BCC6CC', type: 'post-transition' },
    { symbol: 'Lv', name: 'Livermorium', color: '#BCC6CC', type: 'post-transition' },

    // Metalloids
    { symbol: 'B', name: 'Boron', color: '#98FF98', type: 'metalloid' },
    { symbol: 'Si', name: 'Silicon', color: '#98FF98', type: 'metalloid' },
    { symbol: 'Ge', name: 'Germanium', color: '#98FF98', type: 'metalloid' },
    { symbol: 'As', name: 'Arsenic', color: '#98FF98', type: 'metalloid' },
    { symbol: 'Sb', name: 'Antimony', color: '#98FF98', type: 'metalloid' },
    { symbol: 'Te', name: 'Tellurium', color: '#98FF98', type: 'metalloid' },

    // Lanthanides
    { symbol: 'La', name: 'Lanthanum', color: '#FFBFFF', type: 'lanthanide' },
    { symbol: 'Ce', name: 'Cerium', color: '#FFBFFF', type: 'lanthanide' },
    { symbol: 'Pr', name: 'Praseodymium', color: '#FFBFFF', type: 'lanthanide' },
    { symbol: 'Nd', name: 'Neodymium', color: '#FFBFFF', type: 'lanthanide' },
    { symbol: 'Pm', name: 'Promethium', color: '#FFBFFF', type: 'lanthanide' },
    { symbol: 'Sm', name: 'Samarium', color: '#FFBFFF', type: 'lanthanide' },
    { symbol: 'Eu', name: 'Europium', color: '#FFBFFF', type: 'lanthanide' },
    { symbol: 'Gd', name: 'Gadolinium', color: '#FFBFFF', type: 'lanthanide' },
    { symbol: 'Tb', name: 'Terbium', color: '#FFBFFF', type: 'lanthanide' },
    { symbol: 'Dy', name: 'Dysprosium', color: '#FFBFFF', type: 'lanthanide' },
    { symbol: 'Ho', name: 'Holmium', color: '#FFBFFF', type: 'lanthanide' },
    { symbol: 'Er', name: 'Erbium', color: '#FFBFFF', type: 'lanthanide' },
    { symbol: 'Tm', name: 'Thulium', color: '#FFBFFF', type: 'lanthanide' },
    { symbol: 'Yb', name: 'Ytterbium', color: '#FFBFFF', type: 'lanthanide' },
    { symbol: 'Lu', name: 'Lutetium', color: '#FFBFFF', type: 'lanthanide' },

    // Actinides
    { symbol: 'Ac', name: 'Actinium', color: '#FF99CC', type: 'actinide' },
    { symbol: 'Th', name: 'Thorium', color: '#FF99CC', type: 'actinide' },
    { symbol: 'Pa', name: 'Protactinium', color: '#FF99CC', type: 'actinide' },
    { symbol: 'U', name: 'Uranium', color: '#FF99CC', type: 'actinide' },
    { symbol: 'Np', name: 'Neptunium', color: '#FF99CC', type: 'actinide' },
    { symbol: 'Pu', name: 'Plutonium', color: '#FF99CC', type: 'actinide' },
    { symbol: 'Am', name: 'Americium', color: '#FF99CC', type: 'actinide' },
    { symbol: 'Cm', name: 'Curium', color: '#FF99CC', type: 'actinide' },
    { symbol: 'Bk', name: 'Berkelium', color: '#FF99CC', type: 'actinide' },
    { symbol: 'Cf', name: 'Californium', color: '#FF99CC', type: 'actinide' },
    { symbol: 'Es', name: 'Einsteinium', color: '#FF99CC', type: 'actinide' },
    { symbol: 'Fm', name: 'Fermium', color: '#FF99CC', type: 'actinide' },
    { symbol: 'Md', name: 'Mendelevium', color: '#FF99CC', type: 'actinide' },
    { symbol: 'No', name: 'Nobelium', color: '#FF99CC', type: 'actinide' },
    { symbol: 'Lr', name: 'Lawrencium', color: '#FF99CC', type: 'actinide' },

    // Superheavy Elements
    { symbol: 'Rf', name: 'Rutherfordium', color: '#CC9999', type: 'transition' },
    { symbol: 'Db', name: 'Dubnium', color: '#CC9999', type: 'transition' },
    { symbol: 'Sg', name: 'Seaborgium', color: '#CC9999', type: 'transition' },
    { symbol: 'Bh', name: 'Bohrium', color: '#CC9999', type: 'transition' },
    { symbol: 'Hs', name: 'Hassium', color: '#CC9999', type: 'transition' },
    { symbol: 'Mt', name: 'Meitnerium', color: '#CC9999', type: 'transition' },
    { symbol: 'Ds', name: 'Darmstadtium', color: '#CC9999', type: 'transition' },
    { symbol: 'Rg', name: 'Roentgenium', color: '#CC9999', type: 'transition' },
    { symbol: 'Cn', name: 'Copernicium', color: '#CC9999', type: 'transition' }
];

// Combination rules for elements (expanded with valid binary compounds, removed invalid ones like OH which isn't an element)
const combinationRules = {
    // Basic Combinations
    'H+O': { result: 'H2O', name: 'Water', description: 'The most essential compound for life' },
    'H+N': { result: 'NH3', name: 'Ammonia', description: 'A common cleaning compound' },
    'C+O': { result: 'CO2', name: 'Carbon Dioxide', description: 'The gas we exhale' },
    
    // Acids and Bases
    'H+Cl': { result: 'HCl', name: 'Hydrochloric Acid', description: 'A strong acid found in your stomach' },
    'H+F': { result: 'HF', name: 'Hydrofluoric Acid', description: 'A highly corrosive acid' },
    
    // Salts
    'Na+Cl': { result: 'NaCl', name: 'Table Salt', description: 'Common table salt used in cooking' },
    'K+Cl': { result: 'KCl', name: 'Potassium Chloride', description: 'Used as a salt substitute' },
    'Ca+Cl': { result: 'CaCl2', name: 'Calcium Chloride', description: 'Used for de-icing roads' },
    'Zn+I': { result: 'ZnI2', name: 'Zinc Iodide', description: 'A binary ionic compound' },
    
    // Oxides
    'Fe+O': { result: 'Fe2O3', name: 'Iron Oxide', description: 'Common rust' },
    'Al+O': { result: 'Al2O3', name: 'Aluminum Oxide', description: 'Used in sandpaper' },
    'Si+O': { result: 'SiO2', name: 'Silicon Dioxide', description: 'Found in sand and quartz' },
    'Ca+O': { result: 'CaO', name: 'Calcium Oxide', description: 'Also known as quicklime, used in cement' },
    'Mg+O': { result: 'MgO', name: 'Magnesium Oxide', description: 'Used in refractories and antacids' },
    
    // Compounds with Sulfur
    'H+S': { result: 'H2S', name: 'Hydrogen Sulfide', description: 'Smells like rotten eggs' },
    'Fe+S': { result: 'FeS', name: 'Iron Sulfide', description: 'A black mineral' },
    
    // Noble Gas Compounds (rare but possible)
    'Xe+F': { result: 'XeF2', name: 'Xenon Difluoride', description: 'A rare noble gas compound' },
    
    // Interesting Combinations
    'Cu+O': { result: 'CuO', name: 'Copper Oxide', description: 'Black oxide that forms on copper' },
    'Ag+Cl': { result: 'AgCl', name: 'Silver Chloride', description: 'Used in photography' },
    'Au+Cl': { result: 'AuCl3', name: 'Gold Chloride', description: 'Used in gold plating' },
    
    // Common Industrial Compounds
    'N+H': { result: 'NH3', name: 'Ammonia', description: 'Used in fertilizers' },
    'C+H': { result: 'CH4', name: 'Methane', description: 'The simplest hydrocarbon' },
    
    // Additional Binary Molecular Compounds
    'N+O': { result: 'NO', name: 'Nitrogen Monoxide', description: 'A colorless gas used in medicine' },
    'S+Cl': { result: 'S2Cl2', name: 'Disulfur Dichloride', description: 'Used in vulcanization of rubber' },
    'Cl+O': { result: 'Cl2O7', name: 'Dichlorine Heptoxide', description: 'A highly explosive oxide' },
    'C+Cl': { result: 'CCl4', name: 'Carbon Tetrachloride', description: 'Formerly used as a solvent' },
    'P+Cl': { result: 'PCl3', name: 'Phosphorus Trichloride', description: 'Used in organic synthesis' },
    'B+F': { result: 'BF3', name: 'Boron Trifluoride', description: 'A Lewis acid catalyst' },
    'Si+C': { result: 'SiC', name: 'Silicon Carbide', description: 'Known as carborundum, used as abrasive' }
};

// Debug mode state
let debugMode = false;

// Initialize the interface
document.addEventListener('DOMContentLoaded', () => {
    const elementGrid = document.getElementById('elementGrid');
    const combineBtn = document.getElementById('combineBtn');
    
    // Load saved discoveries for the current user
    loadSavedDiscoveries();
    
    // Show debug panel for admins
    const user = JSON.parse(localStorage.getItem('currentUser'));
    if (user && user.role === 'admin') {
        document.querySelector('.debug-panel').style.display = 'block';
    }
    const resultArea = document.getElementById('resultArea');
    const discoveriesList = document.getElementById('discoveriesList');
    const searchInput = document.getElementById('elementSearch');

    // Populate initial elements
    function populateElements(elements) {
        elementGrid.innerHTML = ''; // Clear existing elements
        elements.forEach(element => {
            const elementDiv = createElementDiv(element);
            elementGrid.appendChild(elementDiv);
        });
    }

    // Initial population
    populateElements(initialElements);

    // Search functionality
    searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filteredElements = initialElements.filter(element => 
            element.name.toLowerCase().includes(searchTerm) ||
            element.symbol.toLowerCase().includes(searchTerm) ||
            element.type.toLowerCase().includes(searchTerm)
        );
        populateElements(filteredElements);
    });

    // Handle combining elements
    combineBtn.addEventListener('click', combineElements);
});

function createElementDiv(element) {
    const div = document.createElement('div');
    div.className = 'element';
    div.draggable = true;
    div.style.backgroundColor = element.color;
    div.innerHTML = `
        <div class="element-symbol">${element.symbol}</div>
        <div class="element-name">${element.name}</div>
    `;

    // Add drag event listeners
    div.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', JSON.stringify(element));
    });

    return div;
}

// Drag and drop handlers
function allowDrop(event) {
    event.preventDefault();
    event.currentTarget.classList.add('drag-over');
}

function drop(event) {
    event.preventDefault();
    event.currentTarget.classList.remove('drag-over');
    
    const data = JSON.parse(event.dataTransfer.getData('text/plain'));
    const slot = event.currentTarget;
    
    // Clear existing content
    slot.innerHTML = '';
    
    // Add the dropped element
    const elementDiv = createElementDiv(data);
    elementDiv.draggable = false;
    slot.appendChild(elementDiv);
    
    // Enable combine button if both slots are filled
    const slot1 = document.getElementById('slot1');
    const slot2 = document.getElementById('slot2');
    const combineBtn = document.getElementById('combineBtn');
    
    combineBtn.disabled = !(slot1.children.length && slot2.children.length);
}

function combineElements() {
    const slot1 = document.getElementById('slot1').firstElementChild;
    const slot2 = document.getElementById('slot2').firstElementChild;
    
    if (!slot1 || !slot2) return;
    
    const element1 = slot1.querySelector('.element-symbol').textContent;
    const element2 = slot2.querySelector('.element-symbol').textContent;
    
    // Try both combinations (order doesn't matter)
    const combination = combinationRules[`${element1}+${element2}`] || combinationRules[`${element2}+${element1}`];
    
    if (combination) {
        displayResult(combination);
        
        // Get current user
        const user = JSON.parse(localStorage.getItem('currentUser'));
        if (user) {
            const discovery = {
                id: combination.result,
                name: combination.name,
                formula: combination.result,
                description: combination.description,
                elements: [element1, element2],
                completed: true
            };
            
            // Add discovery using DiscoveryService
            DiscoveryService.addDiscovery(user.username, discovery);
            addToDiscoveries(combination);
            
            // Update debug info if in debug mode
            if (debugMode) {
                updateDebugInfo();
            }
        }
    } else {
        displayNoResult();
    }
}

function displayResult(result) {
    const resultArea = document.getElementById('resultArea');
    resultArea.innerHTML = `
        <div class="result-slot">
            <div class="element" style="background-color: #4CAF50">
                <div class="element-symbol">${result.result}</div>
                <div class="element-name">${result.name}</div>
            </div>
            <div class="result-description">${result.description}</div>
        </div>
    `;
}

function displayNoResult() {
    const resultArea = document.getElementById('resultArea');
    resultArea.innerHTML = `
        <div class="result-slot">
            <div class="slot-label">No reaction occurred</div>
        </div>
    `;
}

function addToDiscoveries(discovery) {
    console.log('[ChemistryCraft] addToDiscoveries called with:', discovery);
    
    // 1. CHECK IF USER IS LOGGED IN
    const currentUser = AuthService.getCurrentUser();
    if (!currentUser) {
        console.error('[ChemistryCraft] ERROR: No user logged in, cannot save discovery');
        alert('Please log in to save discoveries');
        return;
    }
    console.log('[ChemistryCraft] Current user:', currentUser.username);

    // 2. CREATE DISCOVERY DATA OBJECT
    const discoveryData = {
        id: discovery.result,           // e.g., "CH4"
        symbol: discovery.result,       // e.g., "CH4"
        name: discovery.name,           // e.g., "Methane"
        completed: true,
        type: 'compound',
        description: discovery.description
    };
    
    console.log('[ChemistryCraft] Saving discovery to DiscoveryService:', discoveryData);

    // 3. SAVE TO DISCOVERYSERVICE (LOCALSTORAGE)
    try {
        DiscoveryService.addDiscovery(currentUser.username, discoveryData);
        console.log('[ChemistryCraft] ✓ Discovery saved successfully');
    } catch (error) {
        console.error('[ChemistryCraft] ✗ Failed to save discovery:', error);
        return;
    }

    // 4. UPDATE UI - ADD TO DISCOVERIES LIST
    const discoveriesList = document.getElementById('discoveriesList');
    if (!discoveriesList) {
        console.error('[ChemistryCraft] ERROR: discoveriesList element not found');
        return;
    }

    const discoveryItem = document.createElement('div');
    discoveryItem.className = 'discovery-item';
    discoveryItem.innerHTML = `
        <span><strong>${discovery.result}</strong> - ${discovery.name}</span>
    `;
    discoveriesList.appendChild(discoveryItem);
    
    console.log('[ChemistryCraft] ✓ Discovery added to UI');

    // 5. UPDATE DEBUG PANEL
    updateDebugPanel();
}

// Load saved discoveries from DiscoveryService
function loadSavedDiscoveries() {
    const user = JSON.parse(localStorage.getItem('currentUser'));
    if (user) {
        const discoveries = DiscoveryService.getDiscoveries(user.username);
        const discoveriesList = document.getElementById('discoveriesList');
        discoveriesList.innerHTML = ''; // Clear current list
        
        discoveries.forEach(discovery => {
            const discoveryItem = document.createElement('div');
            discoveryItem.className = 'discovery-item';
            discoveryItem.innerHTML = `
                <span>${discovery.formula} - ${discovery.name}</span>
            `;
            discoveriesList.appendChild(discoveryItem);
        });

        // Update debug info if in debug mode
        if (debugMode) {
            updateDebugInfo();
        }
    }
}

// Debug panel functions
function toggleDebug() {
    debugMode = !debugMode;
    const debugInfo = document.getElementById('debugInfo');
    debugInfo.style.display = debugMode ? 'block' : 'none';
    if (debugMode) {
        updateDebugInfo();
    }
}

function updateDebugInfo() {
    const debugInfo = document.getElementById('debugInfo');
    const user = JSON.parse(localStorage.getItem('currentUser'));
    if (user) {
        const userData = DiscoveryService.getUserData(user.username);
        const progress = userData.progress;
        debugInfo.innerHTML = `
            <pre>
User: ${user.username}
Total Discoveries: ${progress.totalDiscoveries}
Completed Discoveries: ${progress.completedDiscoveries}
Progress: ${progress.progressPercentage.toFixed(2)}%

Milestones:
- Beginner (10%): ${progress.milestones.beginner ? '✓' : '✗'}
- Intermediate (50%): ${progress.milestones.intermediate ? '✓' : '✗'}
- Advanced (75%): ${progress.milestones.advanced ? '✓' : '✗'}
- Master (100%): ${progress.milestones.master ? '✓' : '✗'}

Last Login: ${new Date(userData.credentials.lastLogin).toLocaleString()}
            </pre>
        `;
    }
}

function clearAllDiscoveries() {
    const user = JSON.parse(localStorage.getItem('currentUser'));
    if (user && confirm('Are you sure you want to clear all discoveries? This cannot be undone.')) {
        // Reset user data
        DiscoveryService.initializeUserData(user.username);
        // Reload discoveries list
        loadSavedDiscoveries();
    }
}